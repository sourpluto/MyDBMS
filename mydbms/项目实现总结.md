# 数据库管理系统实现总结

## 项目概述

本项目实现了一个完整的数据库管理系统原型，包含SQL编译器、页式存储系统和缓存管理，支持CREATE TABLE、INSERT、SELECT、DELETE等核心SQL操作。

## 1. SQL编译器实现

### 1.1 词法分析器 (LexicalAnalyzer)
- **功能**：将SQL源程序转换为词法标记序列
- **输出格式**：`[种别码，词素值，行号，列号]`
- **支持词法单元**：
  - 关键字：CREATE, TABLE, INSERT, SELECT, DELETE, WHERE等
  - 标识符：表名、列名、数据库名
  - 常量：整数、浮点数、字符串、布尔值
  - 运算符：=, !=, <, >, <=, >=, +, -, *, /
  - 分隔符：(), ,, ;, .
- **错误处理**：遇到非法字符时输出错误提示和位置信息

### 1.2 语法分析器 (Parser)
- **功能**：将词法标记序列转换为抽象语法树(AST)
- **支持语句**：CREATE TABLE、INSERT、SELECT、DELETE、USE DATABASE、SHOW等
- **错误处理**：语法错误时提供错误位置和期望符号提示
- **异常类**：ParseException包含行号、列号和期望符号信息

### 1.3 语义分析器 (SemanticAnalyzer)
- **功能**：对AST进行语义检查
- **检查项目**：
  - 表存在性检查
  - 列存在性检查
  - 数据类型一致性检查
  - 列数/列序检查
  - 主键约束检查
  - 非空约束检查
- **错误格式**：`[错误类型，位置，原因说明]`
- **错误类型**：表不存在、列不存在、类型不匹配、主键冲突等

### 1.4 执行计划生成器 (CodeGenerator)
- **功能**：将AST转换为逻辑执行计划
- **输出格式**：
  - 树形结构：缩进显示计划层次
  - JSON格式：结构化数据表示
  - S表达式：Lisp风格表示
- **计划类型**：CreateTablePlan、InsertPlan、SelectPlan、DeletePlan、FilterPlan等

## 2. 页式存储系统

### 2.1 页文件管理器 (PageFileManager)
- **页大小**：固定4KB
- **页编号**：从0开始的唯一标识
- **核心功能**：
  - `allocatePage()`：分配新页
  - `readPage(pageId)`：读取指定页
  - `writePage(pageId, data)`：写入指定页
  - `appendRecord(recordBytes)`：追加记录到页
  - `scanAllLines()`：扫描所有记录
  - `evictAll()`：清空所有页

### 2.2 缓冲池管理器 (BufferManager)
- **替换策略**：LRU（最近最少使用）
- **统计功能**：
  - 命中次数统计
  - 未命中次数统计
  - 淘汰次数统计
  - 命中率计算
- **日志功能**：
  - 页访问日志（HIT/MISS）
  - 页替换日志（EVICT）
  - 页刷新日志（FLUSH）
- **接口方法**：
  - `get(pageId)`：获取页
  - `put(page)`：放入页
  - `flushPage(pageId)`：刷新指定页
  - `flushAll()`：刷新所有页
  - `printStats()`：打印统计信息

### 2.3 页式存储引擎 (PagedStorageEngine)
- **文件组织**：每个表对应一个`.dat`文件
- **记录格式**：CSV格式，以换行符分隔
- **支持操作**：
  - 数据库创建/删除
  - 表创建/删除
  - 数据插入/查询/删除
  - WHERE条件查询（简化实现）
- **持久化**：所有数据通过页式存储持久化

## 3. 存储抽象层

### 3.1 存储引擎接口 (StorageEngine)
- **统一接口**：屏蔽底层存储实现细节
- **核心方法**：
  - `createDatabase()`, `dropDatabase()`
  - `createTable()`, `listTables()`
  - `insert()`, `select()`, `delete()`

### 3.2 XML存储引擎 (XmlStorageEngine)
- **适配器模式**：复用现有XML函数
- **兼容性**：保持原有XML存储行为
- **功能**：通过function包实现数据操作

### 3.3 页式存储引擎 (PagedStorageEngine)
- **新实现**：基于页式存储的完整实现
- **性能优化**：通过缓冲池提升访问效率
- **条件查询**：支持简单的WHERE条件过滤

## 4. 执行引擎

### 4.1 计划执行器 (PlanExecutor)
- **引擎切换**：支持通过`-Dengine=paged`切换存储引擎
- **默认引擎**：XML存储引擎（保持兼容性）
- **执行流程**：
  1. 接收执行计划
  2. 根据计划类型分发到具体执行方法
  3. 调用存储引擎接口完成数据操作
  4. 处理WHERE条件（通过FilterPlan）

## 5. 系统集成

### 5.1 编译器集成
- **SQLCompiler**：整合词法、语法、语义分析和代码生成
- **调试选项**：支持显示Token、AST、语义分析结果
- **错误处理**：完整的错误报告和位置信息

### 5.2 存储集成
- **统一接口**：执行器通过StorageEngine接口访问存储
- **引擎选择**：运行时动态选择存储引擎
- **数据一致性**：确保数据操作的原子性

## 6. 测试验证

### 6.1 功能测试
- **核心SQL**：CREATE TABLE、INSERT、SELECT、DELETE
- **条件查询**：WHERE子句支持
- **数据持久性**：重启后数据不丢失
- **错误处理**：语法错误、语义错误、I/O错误

### 6.2 性能测试
- **缓存统计**：命中率、未命中率、淘汰次数
- **页访问日志**：详细的页操作记录
- **存储效率**：页式存储的空间利用率

## 7. 运行方式

### 7.1 默认模式（XML引擎）
```bash
java -cp "target/classes;target/dependency/*" Main
```

### 7.2 页式存储模式
```bash
java -Dengine=paged -cp "target/classes;target/dependency/*" Main
```

### 7.3 测试脚本
```bash
# 运行完整测试
run_test.bat

# 使用测试命令
java -cp "target/classes;target/dependency/*" Main < test_commands.txt
```

## 8. 项目特色

### 8.1 模块化设计
- 清晰的层次结构
- 松耦合的组件设计
- 易于扩展和维护

### 8.2 双重存储支持
- XML存储：兼容现有功能
- 页式存储：现代化存储架构
- 统一接口：无缝切换

### 8.3 完整的错误处理
- 词法错误：非法字符检测
- 语法错误：文法规则检查
- 语义错误：类型和约束检查
- 运行时错误：I/O和系统错误

### 8.4 性能监控
- 缓存命中统计
- 页替换日志
- 操作性能分析

## 9. 技术实现

### 9.1 设计模式
- **适配器模式**：XmlStorageEngine适配现有功能
- **策略模式**：不同存储引擎的实现
- **访问者模式**：AST遍历和语义分析

### 9.2 数据结构
- **LRU缓存**：LinkedHashMap实现
- **页管理**：固定大小页的分配和回收
- **AST节点**：递归的树形结构

### 9.3 并发控制
- **同步方法**：BufferManager的线程安全
- **原子操作**：页的读写操作
- **状态管理**：缓存状态的一致性

## 10. 总结

本项目成功实现了一个功能完整的数据库管理系统原型，满足了所有要求：

1. **SQL编译器**：完整的词法、语法、语义分析和代码生成
2. **页式存储**：4KB固定页大小，支持分配、释放、读写
3. **缓存管理**：LRU策略，命中统计，替换日志
4. **系统集成**：执行计划与存储引擎的完整对接
5. **数据持久化**：程序重启后数据不丢失
6. **核心功能**：CREATE、INSERT、SELECT、DELETE的完整支持
7. **错误处理**：详细的错误信息和位置提示
8. **测试验证**：全面的功能测试和性能监控

系统具有良好的可扩展性和维护性，可以作为数据库系统学习和研究的基础平台。
